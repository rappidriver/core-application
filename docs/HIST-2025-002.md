> Este documento Ã© histÃ³rico e pode conter implementaÃ§Ãµes obsoletas. Consulte HIST-2026-012 para a referÃªncia atual.

# HIST-2025-002: Implementar Value Objects do DomÃ­nio

**Status**: âœ… ConcluÃ­da  
**Data**: 02/01/2025  
**Estimativa**: 3 story points  
**Desenvolvedor**: Copilot

## ðŸŽ¯ Objetivos

Implementar os seguintes value objects:

### 1. **Email** âœ…
- ValidaÃ§Ã£o de formato de email
- ImutÃ¡vel
- NormalizaÃ§Ã£o (lowercase)
- MÃ©todos: `getValue()`, `equals()`, `hashCode()`

### 2. **CPF (DocumentId)** âœ…
- ValidaÃ§Ã£o de CPF brasileiro
- FormataÃ§Ã£o e limpeza
- ImutÃ¡vel
- Suporte futuro para outros documentos (RG, CNH, Passport)

### 3. **Phone** âœ…
- ValidaÃ§Ã£o de nÃºmero de telefone
- FormataÃ§Ã£o internacional (country code)
- ImutÃ¡vel

### 4. **Money** âœ…
- RepresentaÃ§Ã£o de valores monetÃ¡rios
- Suporte a mÃºltiplas moedas (BRL, USD, etc.)
- OperaÃ§Ãµes aritmÃ©ticas (add, subtract, multiply)
- ImutÃ¡vel
- Uso de `BigDecimal` para precisÃ£o

### 5. **Location** âœ…
- Latitude e longitude
- ValidaÃ§Ã£o de coordenadas vÃ¡lidas
- CÃ¡lculo de distÃ¢ncia entre pontos (Haversine formula)
- ImutÃ¡vel

### 6. **TenantId** âœ…
- Identificador Ãºnico do tenant (white-label)
- UUID
- ImutÃ¡vel

## ðŸ“ CritÃ©rios de AceitaÃ§Ã£o

### Todos os Value Objects devem:
1. âœ… Ser **imutÃ¡veis** (final fields, sem setters)
2. âœ… Estar no pacote `com.rappidrive.domain.valueobjects`
3. âœ… **NÃƒO ter anotaÃ§Ãµes** de frameworks (Spring, JPA, Jackson)
4. âœ… Ter validaÃ§Ã£o no construtor (lanÃ§ar `IllegalArgumentException` se invÃ¡lido)
5. âœ… Implementar `equals()` e `hashCode()` corretamente
6. âœ… Implementar `toString()` para debugging
7. âœ… Ter testes unitÃ¡rios com cobertura >= 80%

### ValidaÃ§Ãµes EspecÃ­ficas:

**Email:**
- Formato vÃ¡lido (regex)
- NÃ£o pode ser null ou vazio
- Normalizado para lowercase

**CPF:**
- 11 dÃ­gitos
- ValidaÃ§Ã£o de dÃ­gitos verificadores
- Remover formataÃ§Ã£o (pontos e traÃ§os)
- Rejeitar CPFs conhecidos como invÃ¡lidos (111.111.111-11, etc.)

**Phone:**
- Formato: +[country code][number]
- MÃ­nimo 8 dÃ­gitos
- Suportar DDI brasileiro (+55)

**Money:**
- Valor nÃ£o pode ser null
- Suportar moedas: BRL, USD (enum Currency)
- OperaÃ§Ãµes matemÃ¡ticas retornam novos objetos
- ComparaÃ§Ã£o entre valores da mesma moeda

**Location:**
- Latitude: -90 a +90
- Longitude: -180 a +180
- MÃ©todo `distanceTo(Location other)` retorna distÃ¢ncia em km

**TenantId:**
- UUID vÃ¡lido
- NÃ£o pode ser null

## ðŸ—ï¸ Estrutura de Arquivos

```
src/main/java/com/rappidrive/domain/valueobjects/
â”œâ”€â”€ Email.java
â”œâ”€â”€ CPF.java
â”œâ”€â”€ Phone.java
â”œâ”€â”€ Money.java
â”œâ”€â”€ Currency.java (enum)
â”œâ”€â”€ Location.java
â””â”€â”€ TenantId.java

src/test/java/com/rappidrive/domain/valueobjects/
â”œâ”€â”€ EmailTest.java
â”œâ”€â”€ CPFTest.java
â”œâ”€â”€ PhoneTest.java
â”œâ”€â”€ MoneyTest.java
â”œâ”€â”€ LocationTest.java
â””â”€â”€ TenantIdTest.java
```

## ðŸ§ª Casos de Teste

### Email
- âœ… Deve aceitar emails vÃ¡lidos
- âœ… Deve rejeitar emails invÃ¡lidos (sem @, sem domÃ­nio, etc.)
- âœ… Deve normalizar para lowercase
- âœ… Deve rejeitar null/empty

### CPF
- âœ… Deve aceitar CPF vÃ¡lido (com e sem formataÃ§Ã£o)
- âœ… Deve rejeitar CPF com dÃ­gitos verificadores incorretos
- âœ… Deve rejeitar CPFs sequenciais (111.111.111-11)
- âœ… Deve rejeitar CPF com menos/mais de 11 dÃ­gitos

### Phone
- âœ… Deve aceitar telefones com country code
- âœ… Deve aceitar telefone brasileiro com DDI
- âœ… Deve rejeitar nÃºmeros muito curtos
- âœ… Deve formatar corretamente

### Money
- âœ… Deve criar valor monetÃ¡rio com moeda
- âœ… OperaÃ§Ãµes matemÃ¡ticas devem retornar novos objetos
- âœ… NÃ£o deve permitir operaÃ§Ãµes entre moedas diferentes
- âœ… ComparaÃ§Ã£o deve funcionar corretamente

### Location
- âœ… Deve aceitar coordenadas vÃ¡lidas
- âœ… Deve rejeitar latitude/longitude fora dos limites
- âœ… CÃ¡lculo de distÃ¢ncia deve funcionar (Haversine)
- âœ… DistÃ¢ncia entre pontos iguais deve ser 0

### TenantId
- âœ… Deve aceitar UUID vÃ¡lido
- âœ… Deve gerar novo UUID
- âœ… Deve rejeitar UUID invÃ¡lido/null

## ðŸ“ Exemplos de ImplementaÃ§Ã£o

### Email (exemplo)
```java
public final class Email {
    private static final Pattern EMAIL_PATTERN = 
        Pattern.compile("^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$");
    
    private final String value;
    
    public Email(String value) {
        if (value == null || value.isBlank()) {
            throw new IllegalArgumentException("Email cannot be null or empty");
        }
        String normalized = value.trim().toLowerCase();
        if (!EMAIL_PATTERN.matcher(normalized).matches()) {
            throw new IllegalArgumentException("Invalid email format: " + value);
        }
        this.value = normalized;
    }
    
    public String getValue() {
        return value;
    }
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Email email = (Email) o;
        return Objects.equals(value, email.value);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(value);
    }
    
    @Override
    public String toString() {
        return value;
    }
}
```

## ðŸ” ValidaÃ§Ãµes Arquiteturais

- âœ… Nenhum value object pode ter anotaÃ§Ãµes `@Entity`, `@Table`, `@Column`
- âœ… Nenhum value object pode depender de Spring, JPA ou Jackson
- âœ… Todos devem estar em `domain/valueobjects/`
- âœ… Testes arquiteturais devem passar

## â±ï¸ Estimativa

**Tempo estimado**: 4-6 horas

**Breakdown:**
- Email: 30min (simples)
- CPF: 1h (validaÃ§Ã£o complexa)
- Phone: 45min
- Money: 1h (operaÃ§Ãµes matemÃ¡ticas)
- Location: 1.5h (Haversine formula)
- TenantId: 30min (simples)
- Testes: 2h

## ðŸš€ PrÃ³ximas HistÃ³rias Sugeridas

ApÃ³s completar esta histÃ³ria:

1. **HIST-2025-003**: Criar entidade Driver (Motorista)
2. **HIST-2025-004**: Criar entidade Passenger (Passageiro)
3. **HIST-2025-005**: Criar entidade Trip (Corrida)
4. **HIST-2025-006**: Implementar repositÃ³rio de Driver (JPA adapter)

## ðŸ“š ReferÃªncias

- [DDD Value Objects](https://martinfowler.com/bliki/ValueObject.html) - Martin Fowler
- [Haversine Formula](https://en.wikipedia.org/wiki/Haversine_formula) - CÃ¡lculo de distÃ¢ncia
- [CPF Validation Algorithm](https://www.macoratti.net/alg_cpf.htm)

## âœ… Definition of Done

## âœ… CritÃ©rios de AceitaÃ§Ã£o

- [x] Todos os 6 value objects implementados
- [x] Testes unitÃ¡rios com cobertura >= 80% (122 testes, 100% passing)
- [x] Sem anotaÃ§Ãµes de frameworks no domain
- [x] ArchUnit tests passando (7/7)
- [x] Code review completo
- [x] DocumentaÃ§Ã£o no cÃ³digo (JavaDoc)
- [x] Commit com mensagem descritiva

## ðŸ“Š Resultados Finais

**Total de Testes**: 122 testes unitÃ¡rios  
**Status**: âœ… 100% passing (0 falhas)  
**Cobertura**: >= 80% (requisito atendido)  

### DistribuiÃ§Ã£o de Testes
- EmailTest: 17 testes âœ…
- CPFTest: 18 testes âœ…
- PhoneTest: 22 testes âœ… (corrigidos country code extraction e formatting)
- MoneyTest: 24 testes âœ…
- LocationTest: 19 testes âœ… (corrigido locale formatting)
- TenantIdTest: 15 testes âœ…
- HexagonalArchitectureTest: 7 testes âœ… (adicionado allowEmptyShould)

### Problemas Resolvidos
1. **Phone**: Country code extraction extraindo dÃ­gitos incorretos â†’ ValidaÃ§Ã£o especÃ­fica para +55 e +1
2. **Phone**: FormataÃ§Ã£o brasileira nÃ£o funcionando â†’ Ajustado length para 14 (mobile) e 13 (landline)
3. **Location**: toString() usando vÃ­rgula decimal (locale pt_BR) â†’ Usado `Locale.US`
4. **ArchUnit**: Testes falhando por pacotes vazios â†’ Adicionado `.allowEmptyShould(true)`

---

**Prioridade**: Alta (bloqueante para prÃ³ximas histÃ³rias)  
**Complexidade**: Baixa-MÃ©dia  
**ConcluÃ­do em**: 02/01/2025  
**DependÃªncias**: HIST-2025-001 âœ…
