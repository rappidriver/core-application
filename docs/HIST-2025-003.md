> Este documento √© hist√≥rico e pode conter implementa√ß√µes obsoletas. Consulte HIST-2026-012 para a refer√™ncia atual.

# HIST-2025-003: Implementar Entidades do Dom√≠nio

**Status**: ‚úÖ Conclu√≠da  
**Data**: 02/01/2026  
**Estimativa**: 5 story points  
**Desenvolvedor**: Copilot  

## üìã Descri√ß√£o

Implementar as **entidades principais** do dom√≠nio RappiDrive seguindo princ√≠pios de DDD (Domain-Driven Design). Entidades representam objetos com identidade √∫nica e ciclo de vida pr√≥prio, encapsulando comportamentos e regras de neg√≥cio.

## üéØ Objetivos

Implementar as seguintes entidades:

### 1. **Driver** (Motorista)
- **Identidade**: UUID √∫nico
- **Atributos**:
  - Nome completo
  - Email (value object)
  - CPF (value object)
  - Phone (value object)
  - TenantId (multi-tenancy)
  - Status (PENDING_APPROVAL, ACTIVE, INACTIVE, BLOCKED)
  - Localiza√ß√£o atual (Location - opcional quando offline)
  - Data de cadastro
- **Comportamentos**:
  - `activate()`: Ativa motorista ap√≥s aprova√ß√£o
  - `deactivate()`: Desativa motorista
  - `block()`: Bloqueia motorista por viola√ß√£o
  - `updateLocation(Location)`: Atualiza posi√ß√£o em tempo real
  - `isAvailableForRide()`: Verifica se pode aceitar corrida

### 2. **Passenger** (Passageiro)
- **Identidade**: UUID √∫nico
- **Atributos**:
  - Nome completo
  - Email (value object)
  - Phone (value object)
  - TenantId (multi-tenancy)
  - Status (ACTIVE, INACTIVE, BLOCKED)
  - Data de cadastro
- **Comportamentos**:
  - `activate()`: Ativa passageiro
  - `deactivate()`: Desativa passageiro
  - `block()`: Bloqueia por viola√ß√£o de termos
  - `canRequestRide()`: Verifica se pode solicitar corrida

### 3. **Trip** (Viagem/Corrida)
- **Identidade**: UUID √∫nico
- **Atributos**:
  - TenantId (multi-tenancy)
  - Passenger (refer√™ncia)
  - Driver (refer√™ncia - opcional at√© matching)
  - Origem (Location)
  - Destino (Location)
  - Status (REQUESTED, DRIVER_ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED)
  - Dist√¢ncia estimada (calculada)
  - Valor estimado (Money)
  - Data/hora solicita√ß√£o
  - Data/hora in√≠cio
  - Data/hora conclus√£o
- **Comportamentos**:
  - `assignDriver(Driver)`: Atribui motorista √† corrida
  - `start()`: Inicia corrida (valida status e driver)
  - `complete(Money actualFare)`: Finaliza corrida
  - `cancel(String reason)`: Cancela corrida
  - `calculateEstimatedFare()`: Calcula valor estimado

## üèóÔ∏è Princ√≠pios de Design

### Entidades vs Value Objects
- **Entidade**: Tem identidade √∫nica (ID), estado mut√°vel via comportamentos
- **Value Object**: Sem identidade, imut√°vel, comparado por valor

### Invariantes de Neg√≥cio
- Entidades **sempre v√°lidas** (valida√ß√£o no construtor + m√©todos)
- Transi√ß√µes de estado controladas (ex: n√£o pode completar viagem CANCELLED)
- Regras de neg√≥cio encapsuladas (ex: driver precisa estar ACTIVE para aceitar corrida)

### Aggregate Roots
- **Trip** √© aggregate root (controla driver assignment, status transitions)
- **Driver** e **Passenger** s√£o aggregates independentes
- Refer√™ncias entre aggregates via ID (n√£o objetos diretos)

## üìê Estrutura de Arquivos

```
src/main/java/com/rappidrive/domain/
‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ Driver.java
‚îÇ   ‚îú‚îÄ‚îÄ Passenger.java
‚îÇ   ‚îî‚îÄ‚îÄ Trip.java
‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îú‚îÄ‚îÄ DriverStatus.java
‚îÇ   ‚îú‚îÄ‚îÄ PassengerStatus.java
‚îÇ   ‚îî‚îÄ‚îÄ TripStatus.java
‚îî‚îÄ‚îÄ exceptions/
    ‚îú‚îÄ‚îÄ InvalidDriverStateException.java
    ‚îú‚îÄ‚îÄ InvalidPassengerStateException.java
    ‚îî‚îÄ‚îÄ InvalidTripStateException.java

src/test/java/com/rappidrive/domain/entities/
‚îú‚îÄ‚îÄ DriverTest.java
‚îú‚îÄ‚îÄ PassengerTest.java
‚îî‚îÄ‚îÄ TripTest.java
```

## ‚úÖ Crit√©rios de Aceita√ß√£o

- [ ] Entidade Driver com status e comportamentos
- [ ] Entidade Passenger com valida√ß√µes
- [ ] Entidade Trip como aggregate root
- [ ] Enums para status (DriverStatus, PassengerStatus, TripStatus)
- [ ] Exce√ß√µes de dom√≠nio para transi√ß√µes inv√°lidas
- [ ] Valida√ß√£o de invariantes no construtor
- [ ] Transi√ß√µes de estado validadas
- [ ] IDs baseados em UUID
- [ ] TenantId em todas as entidades (multi-tenancy)
- [ ] ZERO depend√™ncias de frameworks (puro Java)
- [ ] Testes unit√°rios >= 80% cobertura
- [ ] Todos os testes passando
- [ ] ArchUnit validando pureza do dom√≠nio

## üß™ Casos de Teste

### DriverTest
- Cria√ß√£o v√°lida com todos os campos obrigat√≥rios
- Valida√ß√£o de campos nulos/vazios
- Transi√ß√µes de status (PENDING ‚Üí ACTIVE ‚Üí INACTIVE)
- Block de motorista ativo
- UpdateLocation quando ativo
- isAvailableForRide() retorna false quando INACTIVE/BLOCKED
- Equals e hashCode baseados em ID

### PassengerTest
- Cria√ß√£o v√°lida
- Valida√ß√£o de campos obrigat√≥rios
- Transi√ß√µes de status
- canRequestRide() valida status

### TripTest
- Cria√ß√£o de corrida com origem/destino
- assignDriver() valida driver dispon√≠vel
- start() s√≥ funciona se driver assigned
- complete() calcula dura√ß√£o
- cancel() n√£o permite re-start
- C√°lculo de dist√¢ncia estimada
- Valida√ß√£o de transi√ß√µes de status

## üìä M√©tricas de Sucesso

- **Testes**: >= 50 testes unit√°rios
- **Cobertura**: >= 80%
- **Complexidade**: Baixa (m√©todos simples, clara responsabilidade)
- **ArchUnit**: 100% compliance (sem frameworks no dom√≠nio)

## üîó Depend√™ncias

**Depende de**:
- ‚úÖ HIST-2025-001 (setup do projeto)
- ‚úÖ HIST-2025-002 (value objects)

**Bloqueia**:
- HIST-2025-004 (ports e interfaces de reposit√≥rio)
- HIST-2025-005 (use cases)

## üìö Refer√™ncias

- [DDD: Entities](https://martinfowler.com/bliki/EvansClassification.html)
- [Aggregate Pattern](https://martinfowler.com/bliki/DDD_Aggregate.html)
- [Domain Events](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/domain-events-design-implementation)

---

**Prioridade**: Alta (bloqueante para use cases)  
**Complexidade**: M√©dia  
**Risco**: Baixo (sem integra√ß√µes externas)

## üìä Resultados Finais

**Total de Testes**: 236 testes unit√°rios (122 value objects + 114 novos)  
**Status**: ‚úÖ 100% passing (0 falhas)  
**Cobertura**: >= 80% atingida  

### Distribui√ß√£o de Testes
**Entidades** (85 testes):
- DriverTest: 32 testes ‚úÖ
- PassengerTest: 22 testes ‚úÖ
- TripTest: 31 testes ‚úÖ

**Value Objects** (144 testes - incluindo DriverLicense):
- DriverLicenseTest: 29 testes ‚úÖ (NOVO - CNH com valida√ß√£o de vencimento)
- EmailTest: 17 testes ‚úÖ
- CPFTest: 18 testes ‚úÖ
- PhoneTest: 22 testes ‚úÖ
- MoneyTest: 24 testes ‚úÖ
- LocationTest: 19 testes ‚úÖ
- TenantIdTest: 15 testes ‚úÖ

**ArchUnit**: 7 testes ‚úÖ

### Entidades Implementadas

**Driver** (`src/main/java/com/rappidrive/domain/entities/Driver.java`)
- Campos: UUID id, TenantId, fullName, Email, CPF, Phone, **DriverLicense (CNH)**, DriverStatus, Location (opcional)
- Comportamentos: `activate()`, `deactivate()`, `block()`, `updateLocation()`, `isAvailableForRide()`
- Regras: Motorista precisa estar ACTIVE, ter localiza√ß√£o **E CNH v√°lida** para aceitar corridas
- Status: PENDING_APPROVAL ‚Üí ACTIVE ‚Üî INACTIVE, BLOCKED

**Passenger** (`src/main/java/com/rappidrive/domain/entities/Passenger.java`)
- Campos: UUID id, TenantId, fullName, Email, Phone, PassengerStatus
- Comportamentos: `activate()`, `deactivate()`, `block()`, `canRequestRide()`
- Status: ACTIVE ‚Üî INACTIVE, BLOCKED

**Trip** (Aggregate Root - `src/main/java/com/rappidrive/domain/entities/Trip.java`)
- Campos: UUID id, TenantId, passengerId, driverId (opcional), origin, destination, TripStatus, dist√¢ncia, fares, timestamps
- Comportamentos: `assignDriver()`, `start()`, `complete()`, `cancel()`, `getDuration()`
- C√°lculo autom√°tico: Dist√¢ncia (Haversine), Tarifa estimada (R$ 5,00 + R$ 2,50/km)
- Fluxo: REQUESTED ‚Üí DRIVER_ASSIGNED ‚Üí IN_PROGRESS ‚Üí COMPLETED/CANCELLED

### Value Object Adicional

**DriverLicense (CNH)** (`src/main/java/com/rappidrive/domain/valueobjects/DriverLicense.java`)
- Campos: n√∫mero (11 d√≠gitos), categoria (A/B/AB/C/D/E), issueDate, expirationDate
- Valida√ß√µes: Formato CNH brasileiro, categoria v√°lida, datas consistentes
- Comportamentos: `isValid()`, `isExpired()`, `getFormatted()` (XXX.XXX.XXX-XX)
- Integra√ß√£o: Driver valida CNH no `isAvailableForRide()`

### Enums Criados
- `DriverStatus`: PENDING_APPROVAL, ACTIVE, INACTIVE, BLOCKED
- `PassengerStatus`: ACTIVE, INACTIVE, BLOCKED
- `TripStatus`: REQUESTED, DRIVER_ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED

### Exce√ß√µes de Dom√≠nio
- `InvalidDriverStateException`: Transi√ß√µes inv√°lidas de Driver
- `InvalidPassengerStateException`: Transi√ß√µes inv√°lidas de Passenger
- `InvalidTripStateException`: Transi√ß√µes inv√°lidas de Trip

## üéØ Arquitetura e Princ√≠pios

‚úÖ **Domain Purity**: Entidades e value objects sem frameworks (puro Java)  
‚úÖ **Aggregate Roots**: Trip controla ciclo de vida completo da viagem  
‚úÖ **Invariantes**: Validadas no construtor e em todas as transi√ß√µes de estado  
‚úÖ **Behavior-rich Entities**: M√©todos de comportamento ao inv√©s de setters  
‚úÖ **Identity**: Equals/hashCode baseados em ID para entidades  
‚úÖ **Value Objects**: DriverLicense adicionado com valida√ß√£o de vencimento  
‚úÖ **Multi-tenancy**: TenantId presente em todas as entidades  
‚úÖ **ArchUnit**: 100% compliance (7/7 testes passing)  

## üîß Melhorias Implementadas

1. **DriverLicense (CNH)**: Adicionado √† entidade Driver conforme solicita√ß√£o do usu√°rio
   - Valida√ß√£o de n√∫mero (11 d√≠gitos)
   - Categorias v√°lidas (A, B, AB, C, D, E, AC, AD, AE)
   - Valida√ß√£o de datas (emiss√£o n√£o pode ser futura, vencimento ap√≥s emiss√£o)
   - Verifica√ß√£o de validade (CNH vencida bloqueia disponibilidade do motorista)
   - 29 testes abrangentes

2. **Regra de Neg√≥cio**: `isAvailableForRide()` agora verifica:
   - Status ACTIVE ‚úì
   - Localiza√ß√£o definida ‚úì
   - CNH v√°lida (n√£o vencida) ‚úì

## üìÅ Arquivos Criados/Modificados

**Enums** (3 arquivos):
- `DriverStatus.java`
- `PassengerStatus.java`
- `TripStatus.java`

**Exce√ß√µes** (3 arquivos):
- `InvalidDriverStateException.java`
- `InvalidPassengerStateException.java`
- `InvalidTripStateException.java`

**Entidades** (3 arquivos):
- `Driver.java` (com DriverLicense integrado)
- `Passenger.java`
- `Trip.java`

**Value Object Adicional** (1 arquivo):
- `DriverLicense.java` ‚≠ê NOVO

**Testes** (4 arquivos):
- `DriverTest.java` (32 testes - atualizado para CNH)
- `PassengerTest.java` (22 testes)
- `TripTest.java` (31 testes)
- `DriverLicenseTest.java` (29 testes) ‚≠ê NOVO

**Total**: 14 arquivos novos

---

**Conclus√£o**: Hist√≥ria HIST-2025-003 conclu√≠da com sucesso! Todas as entidades principais do dom√≠nio implementadas com comportamentos ricos, valida√ß√µes robustas, e 100% dos testes passando. DriverLicense (CNH) adicionado como value object essencial para motoristas.

**Pr√≥ximos Passos**: HIST-2025-004 - Implementar Ports (interfaces de reposit√≥rio e servi√ßos externos)
