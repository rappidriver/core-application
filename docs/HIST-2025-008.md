> Este documento √© hist√≥rico e pode conter implementa√ß√µes obsoletas. Consulte HIST-2026-012 para a refer√™ncia atual.

# HIST-2025-008: Implementar Sistema de Pagamentos e C√°lculo de Tarifas

**Data**: 03/01/2026  
**Status**: üìã TO DO  
**Tipo**: Feature  
**Prioridade**: Alta (Cr√≠tico para MVP)

## Descri√ß√£o

Implementar o m√≥dulo completo de **pagamentos e c√°lculo de tarifas** para a plataforma RappiDrive. Esta funcionalidade √© essencial para o MVP, permitindo que passageiros paguem pelas corridas e motoristas recebam pelos servi√ßos prestados. O sistema deve suportar m√∫ltiplos m√©todos de pagamento e calcular tarifas dinamicamente baseado em dist√¢ncia, tempo e categoria do ve√≠culo.

## Contexto de Neg√≥cio

**Motiva√ß√£o**:
- Pagamento √© essencial para fechar o ciclo de neg√≥cio (corrida ‚Üí pagamento ‚Üí conclus√£o)
- Passageiros precisam de m√∫ltiplas op√ß√µes de pagamento (cart√£o, PIX, dinheiro)
- Motoristas precisam rastreamento de ganhos
- Plataforma precisa calcular comiss√£o
- Conformidade com regulamenta√ß√£o financeira

**Fluxo de Pagamento**:
1. Corrida √© solicitada ‚Üí Tarifa estimada √© calculada
2. Corrida √© completada ‚Üí Tarifa final √© calculada
3. Pagamento √© processado (cart√£o/PIX) ou registrado (dinheiro)
4. Valor √© dividido: motorista + comiss√£o plataforma
5. Hist√≥rico de transa√ß√µes √© mantido para auditoria

## Regras de Neg√≥cio

### C√°lculo de Tarifa
1. **Tarifa Base**: Cada tenant define tarifa base + valor por km + valor por minuto
2. **Categoria de Ve√≠culo**: SEDAN (1.0x), HATCHBACK (0.9x), SUV (1.2x)
3. **Hor√°rio**: Pico (1.5x), Normal (1.0x), Madrugada (1.3x)
4. **Tarifa M√≠nima**: Cada tenant define valor m√≠nimo por corrida
5. **Arredondamento**: Sempre para cima (R$ 12.34 ‚Üí R$ 12.40)

### Pagamento
6. **M√©todos Aceitos**: CREDIT_CARD, DEBIT_CARD, PIX, CASH
7. **Pagamento Cart√£o/PIX**: Processado via gateway (Stripe/Mercado Pago)
8. **Pagamento Dinheiro**: Registrado, mas n√£o processado
9. **Comiss√£o Plataforma**: 20% do valor da corrida
10. **Reembolso**: Apenas para cart√£o/PIX, em at√© 7 dias

### Estados de Pagamento
11. **PENDING**: Aguardando processamento
12. **PROCESSING**: Em processamento no gateway
13. **COMPLETED**: Pago com sucesso
14. **FAILED**: Falha no processamento
15. **REFUNDED**: Valor estornado

## Objetivos

### Domain Layer
1. ‚úÖ **Payment Entity**: Aggregate root para pagamento
2. ‚úÖ **Fare Entity**: C√°lculo e detalhamento da tarifa
3. ‚úÖ **FareConfiguration Entity**: Configura√ß√£o de tarifas por tenant (parametriz√°vel)
4. ‚úÖ **Value Objects**: Money, PaymentMethod, FareBreakdown
5. ‚úÖ **Enums**: PaymentStatus, PaymentMethodType, FareMultiplier
6. ‚úÖ **Business Rules**: Valida√ß√µes de pagamento e c√°lculo de tarifa

### Application Layer
7. ‚úÖ **Output Ports**: PaymentRepositoryPort, PaymentGatewayPort, FareConfigurationRepositoryPort
8. ‚úÖ **Input Ports**: ProcessPayment, CalculateFare, GetPayment, RefundPayment, ManageFareConfiguration
9. ‚úÖ **Use Cases**: Implementa√ß√µes com l√≥gica de neg√≥cio

### Infrastructure Layer
10. ‚úÖ **JPA Entities**: PaymentJpaEntity, FareJpaEntity, FareConfigurationJpaEntity
11. ‚úÖ **Repositories**: Spring Data JPA repositories
12. ‚úÖ **Adapters**: Payment gateway adapter (mock/Stripe)
13. ‚úÖ **Mappers**: PaymentMapper, FareMapper, FareConfigurationMapper
14. ‚úÖ **Migration**: V5__Create_payments_and_fare_config_tables.sql

### Presentation Layer
15. ‚úÖ **REST Controllers**: PaymentController, FareController, FareConfigurationController (Admin)
16. ‚úÖ **DTOs**: PaymentRequest, FareEstimateRequest, PaymentResponse, FareResponse, FareConfigurationRequest/Response
17. ‚úÖ **Mappers**: PaymentDtoMapper, FareDtoMapper, FareConfigurationDtoMapper

### Testing
18. ‚úÖ **Unit Tests**: PaymentTest, FareTest, FareConfigurationTest, MoneyTest (j√° existe)
19. ‚úÖ **Use Case Tests**: ProcessPaymentUseCaseTest, CalculateFareUseCaseTest, UpdateFareConfigurationUseCaseTest
20. ‚úÖ **Architecture Tests**: Atualizar regras

## Estrutura de Pacotes

```
src/main/java/com/rappidrive/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Payment.java                                 ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Fare.java                                    ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FareConfiguration.java                       ‚úÖ NEW
‚îÇ   ‚îú‚îÄ‚îÄ valueobjects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Money.java                                   ‚úÖ EXISTS (enhance)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PaymentMethod.java                           ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FareBreakdown.java                           ‚úÖ NEW
‚îÇ   ‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PaymentStatus.java                           ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PaymentMethodType.java                       ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FareMultiplierType.java                      ‚úÖ NEW
‚îÇ   ‚îî‚îÄ‚îÄ exceptions/
‚îÇ       ‚îú‚îÄ‚îÄ PaymentNotFoundException.java                ‚úÖ NEW
‚îÇ       ‚îú‚îÄ‚îÄ InvalidFareException.java                    ‚úÖ NEW
‚îÇ       ‚îî‚îÄ‚îÄ FareConfigurationNotFoundException.java      ‚úÖ NEW
‚îÇ       ‚îî‚îÄ‚îÄ InvalidFareException.java                    ‚úÖ NEW
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îú‚îÄ‚îÄ ports/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ProcessPaymentInputPort.java         ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RefundPaymentInputPort.java          ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GetFareConfigurationInputPort.java   ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ UpdateFareConfigurationInputPort.java ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ output/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PaymentRepositoryPort.java               ‚úÖ NEW
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PaymentGatewayPort.java                  ‚úÖ NEW
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ FareConfigurationRepositoryPort.java     ‚úÖ NEW
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PaymentGatewayPort.java                  ‚úÖ NEW
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ FareCalculatorPort.java                  ‚úÖ NEW
‚îÇ   ‚îî‚îÄ‚îÄ usecases/
‚îÇ       ‚îî‚îÄ‚îÄ ‚îú‚îÄ‚îÄ RefundPaymentUseCase.java                ‚úÖ NEW
‚îÇ           ‚îú‚îÄ‚îÄ GetFareConfigurationUseCase.java         ‚úÖ NEW
‚îÇ           ‚îî‚îÄ‚îÄ UpdateFareConfigurationUseCase.java
‚îÇ           ‚îú‚îÄ‚îÄ ProcessPaymentUseCase.java               ‚úÖ NEW
‚îÇ           ‚îú‚îÄ‚îÄ CalculateFareUseCase.java                ‚úÖ NEW
‚îÇ           ‚îú‚îÄ‚îÄ GetPaymentUseCase.java                   ‚úÖ NEW
‚îÇ           ‚îú‚îÄ‚îÄ FareJpaEntity.java                       ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FareConfigurationJpaEntity.java          ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SpringDataPaymentRepository.java         ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SpringDataFareRepository.java            ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SpringDataFareConfigurationRepository.java ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JpaPaymentRepositoryAdapter.java         ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JpaFareConfigurationRepositoryAdapter.java ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MockPaymentGatewayAdapter.java           ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mappers/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PaymentMapper.java                       ‚úÖ NEW
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ FareMapper.java                          ‚úÖ NEW
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ FareConfigurationMapper.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JpaPaymentRepositoryAdapter.java         ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MockPaymentGatewayAdapter.java           ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FareController.java                          ‚úÖ NEW
    ‚îÇ   ‚îî‚îÄ‚îÄ admin/
    ‚îÇ       ‚îî‚îÄ‚îÄ FareConfigurationController.java         ‚úÖ NEW (Admin API)
    ‚îú‚îÄ‚îÄ dto/
    ‚îÇ   ‚îú‚îÄ‚îÄ request/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProcessPaymentRequest.java               ‚úÖ NEW
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FareEstimateRequest.java                 ‚úÖ NEW
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefundPaymentRequest.java                ‚úÖ NEW
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UpdateFareConfigurationRequest.java      ‚úÖ NEW
    ‚îÇ   ‚îî‚îÄ‚îÄ response/
    ‚îÇ       ‚îú‚îÄ‚îÄ PaymentResponse.java                     ‚úÖ NEW
    ‚îÇ       ‚îú‚îÄ‚îÄ FareResponse.java                        ‚úÖ NEW
    ‚îÇ       ‚îî‚îÄ‚îÄ FareConfigurationResponse.java           ‚úÖ NEW
    ‚îî‚îÄ‚îÄ mappers/
        ‚îú‚îÄ‚îÄ PaymentDtoMaand_fare_config_tables.sql       ‚úÖ NEW
        ‚îú‚îÄ‚îÄ FareDtoMapper.java                           ‚úÖ NEW
        ‚îî‚îÄ‚îÄ FareConfigurationDtoMapper.java              ‚úÖ NEW
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FareEstimateRequest.java                 ‚úÖ NEW
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RefundPaymentRequest.java                ‚úÖ NEW
    ‚îÇ   ‚îî‚îÄ‚îÄ response/
    ‚îÇ       ‚îú‚îÄ‚îÄ PaymentResponse.java                     ‚úÖ NEW
    ‚îÇ       ‚îî‚îÄ‚îÄ FareResponse.java                        ‚úÖ NEW
    ‚îî‚îÄ‚îÄ ‚îú‚îÄ‚îÄ FareTest.java                                ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FareConfigurationTest.java
        ‚îú‚îÄ‚îÄ PaymentDtoMapper.java                        ‚úÖ NEW
        ‚îî‚îÄ‚îÄ FareDtoMapper.java                           ‚úÖ NEW

src/main/resources/db/migration/
‚îî‚îÄ‚îÄ V5__Create_payments_tables.sql                       ‚úÖ NEW

src/test/java/com/rappidrive/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ enti‚îú‚îÄ‚îÄ CalculateFareUseCaseTest.java            ‚úÖ NEW
‚îÇ           ‚îî‚îÄ‚îÄ UpdateFareConfigurationUseCaseTest.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PaymentTest.java                             ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FareTest.java                                ‚úÖ NEW
‚îÇ   ‚îî‚îÄ‚îÄ valueobjects/
‚îÇ       ‚îú‚îÄ‚îÄ PaymentMethodTest.java                       ‚úÖ NEW
‚îÇ       ‚îî‚îÄ‚îÄ FareBreakdownTest.java                       ‚úÖ NEW
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îî‚îÄ‚îÄ usecases/
‚îÇ       ‚îî‚îÄ‚îÄ payment/
‚îÇ           ‚îú‚îÄ‚îÄ ProcessPaymentUseCaseTest.java           ‚úÖ NEW
‚îÇ           ‚îî‚îÄ‚îÄ CalculateFareUseCaseTest.java            ‚úÖ NEW
‚îî‚îÄ‚îÄ architecture/
    ‚îî‚îÄ‚îÄ HexagonalArchitectureTest.java                   ‚úÖ MODIFIED
```

## Domain Model

### Payment Entity

**Campos**:
```java
public class Payment {
    private final UUID id;
    private final UUID tripId;                    // Corrida associada
    private final TenantId tenantId;
    private final Money amount;                   // Valor total
    private final Money platformFee;              // Comiss√£o (20%)
    private final Money driverAmount;             // Valor motorista (80%)
    private final PaymentMethod paymentMethod;
    private PaymentStatus status;
    private String gatewayTransactionId;          // ID no gateway externo
    private String failureReason;                 // Motivo de falha
    private final LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private LocalDateTime processedAt;
}
```

**Comportamentos**:
```java
public void process(String gatewayTransactionId)     // Status ‚Üí PROCESSING
public void complete()                               // Status ‚Üí COMPLETED
public void fail(String reason)                      // Status ‚Üí FAILED
public void refund()                                 // Status ‚Üí REFUNDED
public boolean canBeRefunded()                       // COMPLETED + cart√£o/PIX
public Money calculatePlatformFee()                  // 20% do total
public Money calculateDriverAmount()                 // 80% do total
```

**Invariantes**:
- amount > 0
- platformFee = 20% amount
- driverAmount = 80% amount
- status n√£o pode retroceder (COMPLETED ‚Üí PENDING inv√°lido)
- Apenas CREDIT_CARD, DEBIT_CARD, PIX podem ser refunded

### Fare Entity

**Campos**:
```java
public class Fare {
    private final UUID id;
    private final UUID tripId;
    private final TenantId tenantId;
    private final Money baseFare;                 // Tarifa base
    private final double distanceKm;              // Dist√¢ncia percorrida
    private final int durationMinutes;            // Dura√ß√£o da corrida
    private final Money distanceFare;             // Valor por km
    private final Money timeFare;                 // Valor por minuto
    private final FareMultiplFareConfiguration config, distanceKm, 
                             durationMinutes, VehicleType, LocalDateTime)
public double getVehicleMultiplier()             // 0.9 / 1.0 / 1.2
public double getTimeMultiplier()                // 1.0 / 1.5 / 1.3
public FareBreakdown getBreakdown()              // Detalhamento completo
```

### FareConfiguration Entity

**Campos**:
```java
public class FareConfiguration {
    private final UUID id;
    private final TenantId tenantId;
    private Money baseFare;                       // Tarifa base (ex: R$ 4.00)
    private Money pricePerKm;                     // Valor por km (ex: R$ 1.00)
    private Money pricePerMinute;                 // Valor por min (ex: R$ 0.20)
    private Money minimumFare;                    // Tarifa m√≠nima (ex: R$ 8.00)
    private double platformCommissionRate;        // % comiss√£o (ex: 0.20 = 20%)
    private final LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

**Comportamentos**:
```java
public void updateBaseFare(Money baseFare)
public void updatePricePerKm(Money pricePerKm)
public void updatePricePerMinute(Money pricePerMinute)
public void updateMinimumFare(Money minimumFare)
public void updateCommissionRate(double rate)
public Money calculatePlatformFee(Money totalAmount)
public Money calculateDriverAmount(Money totalAmount)
public boolean belongsToTenant(TenantId tenantId)
```

**Invariantes**:
- Todos os valores monet√°rios devem ser > 0
- platformCommissionRate entre 0.0 e 1.0 (0% a 100%)
- minimumFare >= baseFare
- Apenas um FareConfiguration ativo por tenant
```

**Comportamentos**:
```java
public static Fare calculate(TenantId, distanceKm, durationMinutes, 
                             VehicleType, LocalDateTime)
public Money getMinimumFare()                    // Tarifa m√≠nima do tenant
public double getVehicleMultiplier()             // 0.9 / 1.0 / 1.2
public double getTimeMultiplier()                // 1.0 / 1.5 / 1.3
public FareBreakdown getBreakdown()              // Detalhamento completo
```

### PaymentMethod Value Object

**Campos**:
```java
public final class PaymentMethod {
    private final PaymentMethodType type;         // CREDIT_CARD, DEBIT_CARD, PIX, CASH
    private final String cardLast4;               // √öltimos 4 d√≠gitos (se cart√£o)
    private final String cardBrand;               // VISA, MASTERCARD, etc
    private final String pixKey;                  // Chave PIX (se PIX)
}
```

### FareBreakdown Value Object

**Campos**:
```java
public final class FareBreakdown {
    private final Money baseFare;
    private final Money distanceFare;
    private final Money timeFare;
    private final Money subtotal;
    private final double vehicleMultiplier;
    private final double timeMultiplier;
    private final Money totalMultiplier;
    private final Money minimumFare;
    private final Moneyand_fare_config_tables.sql

-- Tabela de configura√ß√£o de tarifas por tenant (parametriz√°vel via Admin)
CREATE TABLE IF NOT EXISTS fare_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL UNIQUE,
    
    -- Valores de tarifa (em centavos)
    base_fare_cents BIGINT NOT NULL,
    price_per_km_cents BIGINT NOT NULL,
    price_per_minute_cents BIGINT NOT NULL,
    minimum_fare_cents BIGINT NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'BRL',
    
    -- Comiss√£o da plataforma
    platform_commission_rate DECIMAL(5,4) NOT NULL DEFAULT 0.2000,  -- 20%
    
    -- Audit
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_fare_config_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    CONSTRAINT chk_fare_config_amounts CHECK (
        base_fare_cents > 0 AND 
        price_per_km_cents > 0 AND 
        price_per_minute_cents > 0 AND
        minimum_fare_cents > 0 AND
        minimum_fare_cents >= base_fare_cents
    ),
    CONSTRAINT chk_platform_commission_rate CHECK (
        platform_commission_rate >= 0.0 AND 
        platform_commission_rate <= 1.0
    )
);

-- Index para busca por tenant
CREATE INDEX idx_fare_configurations_tenant ON fare_configurations(tenant_id);

-- Trigger para updated_at
CREATE TRIGGER update_fare_configurations_updated_at 
    BEFORE UPDATE ON fare_configurations
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- Inserir configura√ß√£o padr√£o para cada tenant existente
INSERT INTO fare_configurations (tenant_id, base_fare_cents, price_per_km_cents, price_per_minute_cents, minimum_fare_cents)
SELECT id, 400, 100, 20, 800 FROM tenants
ON CONFLICT (tenant_id) DO NOTHING;
-- Padr√£o: R$ 4.00 base, R$ 1.00/km, R$ 0.20/min, R$ 8.00 m√≠nima, 20% comiss√£ont;
}
```

### Enums

**PaymentStatus**:
```java
public enum PaymentStatus {
    PENDING,       // Aguardando processamento
    PROCESSING,    // Em processamento no gateway
    COMPLETED,     // Pago com sucesso
    FAILED,        // Falha no processamento
    REFUNDED       // Valor estornado
}
```

**PaymentMethodType**:
```java
public enum PaymentMethodType {
    CREDIT_CARD,   // Cart√£o de cr√©dito
    DEBIT_CARD,    // Cart√£o de d√©bito
    PIX,           // PIX (Brasil)
    CASH           // Dinheiro
}
```

**FareMultiplierType**:
```java
public enum FareMultiplierType {
    NORMAL(1.0),       // Hor√°rio normal
    PEAK(1.5),         // Hor√°rio de pico (7-9h, 17-19h)
    LATE_NIGHT(1.3);   // Madrugada (0-6h)
    
    private final double multiplier;
}
```

## Database Schema (Migration V5)

```sql
-- V5__Create_payments_tables.sql

-- Tabela de tarifas
CREATE TABLE IF NOT EXISTS fares (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    trip_id UUID NOT NULL UNIQUE,
    tenant_id UUID NOT NULL,
    
    -- C√°lculo
    base_fare_amount DECIMAL(10,2) NOT NULL,
    distance_km DECIMAL(10,2) NOT NULL,
    duration_minutes _configurations IS 'Configurable fare pricing per tenant (managed via Admin API)';
COMMENT ON TABLE fares IS 'Fare calculations for trips';
COMMENT ON TABLE payments IS 'Payment transactions for completed trips';
COMMENT ON COLUMN payments.amount_cents IS 'Total amount in cents to avoid floating point errors';
COMMENT ON COLUMN payments.platform_fee_cents IS 'Platform commission in cents (rate from fare_configurations)';
COMMENT ON COLUMN payments.driver_amount_cents IS 'Driver earnings in cents (100% - commission rate)
    multiplier_type VARCHAR(20) NOT NULL,
    vehicle_category VARCHAR(20) NOT NULL,
    
    -- Resultado
    total_before_multiplier DECIMAL(10,2) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    
    -- Audit
    calculated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_fare_trip FOREIGN KEY (trip_id) REFERENCES trips(id),
    CONSTRAINT fk_fare_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    CONSTRAINT chk_fare_amounts CHECK (
        base_fare_amount >= 0 AND 
        distance_km >= 0 AND 
        duration_minutes >= 0 AND
        total_amount >= 0
    ),
    CONSTRAINT chk_multiplier_type CHECK (
        multiplier_type IN ('NORMAL', 'PEAK', 'LATE_NIGHT')
    )
);

-- Tabela de pagamentos
CREATE TABLE IF NOT EXISTS payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    trip_id UUID NOT NULL UNIQUE,
    tenant_id UUID NOT NULL,
    FareConfiguration do tenant no banco de dados
- Se n√£o existir, lan√ßar FareConfigurationNotFoundException
- Calcular tarifa base + (dist√¢ncia √ó pricePerKm) + (tempo √ó pricePerMinute)
- Aplicar multiplicador de hor√°rio (normal/pico/madrugada)
- Aplicar multiplicador de categoria do ve√≠culo
- Garantir tarifa m√≠nima (config.minimumFare)BIGINT NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'BRL',
    
    -- M√©todo de pagamento
    payment_method_type VARCHAR(20) NOT NULL,
    card_last4 VARCHAR(4),
    card_brand VARCHAR(20),
    pix_key VARCHAR(100),
    
    -- Status
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    gateway_transaction_id VARCHAR(100),
    failure_reason TEXT,
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP,
  Buscar FareConfiguration do tenant para obter taxa de comiss√£o
- Criar Payment com status PENDING
- Calcular comiss√£o (config.platformCommissionRate √ó amount) e valor motoristaid) REFERENCES trips(id),
    CONSTRAINT fk_payment_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    CONSTRAINT chk_payment_status CHECK (
        status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'REFUNDED')
    ),
    CONSTRAINT chk_payment_method_type CHECK (
        payment_method_type IN ('CREDIT_CARD', 'DEBIT_CARD', 'PIX', 'CASH')
    ),
    CONSTRAINT chk_payment_amounts CHECK (
        amount_cents > 0 AND 
        platform_fee_cents >= 0 AND 
        driver_amount_cents >= 0 AND
        platform_fee_cents + driver_amount_cents = amount_cents
    )
);

-- Indexes
CREATE INDEX idx_fares_trip ON fares(trip_id);
CREATE INDEX idx_fares_tenant ON fares(tenant_id);
CREATE INDEX idx_fares_calculated_at ON fares(calculated_at);

CREATE INDEX idx_payments_trip ON payments(trip_id);
CREATE INDEX idx_payments_tenant ON payments(tenant_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_created_at ON payments(created_at);
CREATE INDEX idx_payments_gateway_transaction ON payments(gateway_transaction_id);

-- Comments
COMMENT ON TABLE fares IS 'Fare calculations for trips';
COMMENT ON TABLE payments IS 'Payment transactions for completed trips';
COM

### 5. GetFareConfigurationInputPort (Admin)

**Input Port**:
```java
public interface GetFareConfigurationInputPort {
    FareConfiguration execute(TenantId tenantId);
}
```

**Regras**:
- Buscar configura√ß√£o por tenant
- Se n√£o existir, lan√ßar FareConfigurationNotFoundException
- Retornar configura√ß√£o atual

### 6. UpdateFareConfigurationInputPort (Admin)

**Input Port**:
```java
public interface UpdateFareConfigurationInputPort {
    FareConfiguration execute(UpdateFareConfigurationCommand command);
    
    record UpdateFareConfigurationCommand(
        TenantId tenantId,
        Money baseFare,
        Money pricePerKm,
        Money pricePerMinute,
        Money minimumFare,
        double platformCommissionRate
    ) {
        public UpdateFareConfigurationCommand {
            if (baseFare == null || baseFare.isNegativeOrZero())
                throw new IllegalArgumentException("baseFare must be positive");
            if (pricePerKm == null || pricePerKm.isNegativeOrZero())
                throw new IllegalArgumentException("pricePerKm must be positive");
            if (pricePerMinute == null || pricePerMinute.isNegativeOrZero())
                throw new IllegalArgumentException("pricePerMinute must be positive");
            if (minimumFare == null || minimumFare.isNegativeOrZero())
                throw new IllegalArgumentException("minimumFare must be positive");
            if (minimumFare.isLessThan(baseFare))
                throw new IllegalArgumentException("minimumFare must be >= baseFare");
            if (platformCommissionRate < 0.0 || platformCommissionRate > 1.0)
                throw new IllegalArgumentException("platformCommissionRate must be between 0.0 and 1.0");
        }
    }
}
```

**Regras**:
- Buscar FareConfiguration do tenant
- Se n√£o existir, criar novo
- Validar todos os valores (positivos, minimumFare >= baseFare, taxa entre 0-1)
- Atualizar campos
- Salvar no banco
- Retornar configura√ß√£o atualizadaMENT ON COLUMN payments.amount_cents IS 'Total amount in cents to avoid floating point errors';
COMMENT ON COLUMN payments.platform_fee_cents IS 'Platform commission (20%) in cents';
COMMENT ON COLUMN payments.driver_amount_cents IS 'Driver earnings (80%) in cents';

-- Trigger para updated_at
CREATE TRIGGER update_payments_updated_at 
    BEFORE UPDATE ON payments
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

## Use Cases

### 1. CalculateFareUseCase

**Input Port**:
```java
public interface CalculateFareInputPort {
    Fare execute(CalculateFareCommand command);
    
    record CalculateFareCommand(
        UUID tripId,
        TenantId tenantId,
        double distanceKm,
        int durationMinutes,
        VehicleType vehicleCategory,
        LocalDateTime tripTime
    ) {}
}
```

**Regras**:
- Buscar configura√ß√£o de tarifa do tenant (base, por km, por min, m√≠nima)
- Calcular tarifa base + dist√¢ncia + tempo
- Aplicar multiplicador de hor√°rio (normal/pico/madrugada)
- Aplicar multiplicador de categoria do ve√≠culo
- Garantir tarifa m√≠nima
- Arredondar para cima (m√∫ltiplos de R$ 0,10)

### 2. ProcessPaymentUseCase

**Input Port**:
```java
public interface ProcessPaymentInputPort {
    Payment execute(ProcessPaymentCommand command);
    
    record ProcessPaymentCommand(
        UUID tripId,
        PaymentMethod paymentMethod
    ) {}
}
```

**Regras**:
- Buscar Fare da corrida
- Criar Payment com status PENDING
- Calcular comiss√£o (20%) e valor motorista (80%)
- Se CREDIT_CARD/DEBIT_CARD/PIX: processar via gateway
- Se CASH: marcar como COMPLETED sem processamento
- Atualizar status conforme resultado do gateway
- Atualizar Trip.status para COMPLETED ap√≥s pagamento

### 3. RefundPaymentUseCase

**Input Port**:
```java
public interface RefundPaymentInputPort {
    Payment execute(UUID paymentId, String reason);
}
```

**Regras**:
- Apenas pagamentos COMPLETED podem ser refunded
- Apenas CREDIT_CARD, DEBIT_CARD, PIX (n√£o CASH)
- Processar reembolso via gateway
- Atualizar status para REFUNDED
- R

---

## Admin API - Configura√ß√£o de Tarifas

### GET /api/v1/admin/fare-configurations/{tenantId}
```json
Response: 200 OK
{
  "id": "uuid",
  "tenantId": "uuid",
  "baseFare": 4.00,
  "pricePerKm": 1.00,
  "pricePerMinute": 0.20,
  "minimumFare": 8.00,
  "platformCommissionRate": 0.20,
  "createdAt": "2026-01-03T10:00:00",
  "updatedAt": "2026-01-03T10:00:00"
}
```

### PUT /api/v1/admin/fare-configurations/{tenantId}
```json
Request:
{
  "baseFare": 5.00,
  "pricePerKm": 1.20,
  "pricePerMinute": 0.25,
  "minimumFare": 10.00,
  "platformCommissionRate": 0.25
}

Response: 200 OK
{

**FareConfigurationTest** (~20 tests):
- ‚úÖ shouldCreateFareConfigurationWithValidData
- ‚úÖ shouldUpdateBaseFare
- ‚úÖ shouldUpdatePricePerKm
- ‚úÖ shouldUpdatePricePerMinute
- ‚úÖ shouldUpdateMinimumFare
- ‚úÖ shouldUpdateCommissionRate
- ‚úÖ shouldCalculatePlatformFeeCorrectly
- ‚úÖ shouldCalculateDriverAmountCorrectly
- ‚úÖ shouldThrowExceptionWhenBaseFareIsZero
- ‚úÖ shouldThrowExceptionWhenMinimumFareLessThanBase
- ‚úÖ shouldThrowExceptionWhenCommissionRateNegative
- ‚úÖ shouldThrowExceptionWhenCommissionRateGreaterThanOne
- ‚úÖ belongsToTenantShouldReturnTrueForSameTenant
- ‚úÖ belongsToTenantShouldReturnFalseForDifferentTenant
  "id": "uuid",
  "tenantId": "uuid",
  "baseFare": 5.00,
  "pricePerKm": 1.20,
  "pricePerMinute": 0.25,
  "minimumFare": 10.00,
  "platformCommissionRate": 0.25,
  "updatedAt": "2026-01-03T14:30:00"
}
```
2 tests):
- ‚úÖ shouldCalculateNormalFare
- ‚úÖ shouldCalculatePeakHourFare
- ‚úÖ shouldCalculateLateNightFare
- ‚úÖ shouldApplyMinimumFare
- ‚úÖ shouldCalculateForDifferentVehicleTypes
- ‚úÖ shouldUseTenantFareConfiguration
- ‚úÖ shouldThrowExceptionWhenFareConfigurationNotFound

**UpdateFareConfigurationUseCaseTest** (~10 tests):
- ‚úÖ shouldUpdateExistingConfiguration
- ‚úÖ shouldCreateNewConfigurationIfNotExists
- ‚úÖ shouldValidateAllFields
- ‚úÖ shouldThrowExceptionWhenMinimumFareLessThanBase
- ‚úÖ shouldThrowExceptionWhenCommissionRateInvalidsar
- Tenant deve existir antes de criar configura√ß√£oegistrar motivo do reembolso

### 4. GetPaymentInputPort

**Input Port**:
```java
public interface GetPaymentInputPort {
    Payment execute(UUID paymentId);
    List<Payment> findByTrip(UUID tripId);
    List<Payment> findByTenant(TenantId tenantId, LocalDateTime from, LocalDateTime to);
}
```

## Payment Gateway Port

**Interface**:
```java
public interface PaymentGatewayPort {
    PaymentGatewayResponse processPayment(PaymentGatewayRequest request);
    PaymentGatewayResponse refundPayment(String transactionId, Money amount);
    
    record PaymentGatewayRequest(
        Money amount,
        PaymentMethod paymentMethod,
        String description
    ) {}
    
    record PaymentGatewayResponse(
        boolean success,
        String transactionId,
        String failureReason
    ) {}
}
```

**Implementa√ß√£o Mock** (para MVP):
```javaFareConfigurationRepositoryPort.class)
.orShould().implement(ProcessPaymentInputPort.class)
.orShould().implement(CalculateFareInputPort.class)
.orShould().implement(GetPaymentInputPort.class)
.orShould().implement(RefundPaymentInputPort.class)
.orShould().implement(GetFareConfigurationInputPort.class)
.orShould().implement(UpdateFareConfiguration
    public PaymentGatewayResponse processPayment(PaymentGatewayRequest request) {
        // Simula processamento com 95% sucesso
        boolean success = Math.random() > 0.05;
        return new PaymentGatewayResponse(
            success,
            UUID.randomUUID().toString(),
            success ? null : "Insufficient funds"
        );
    }
}
```

## REST API

### POST /api/v1/fares/estimate
```json
Request:
{
  "tripId": "uuid",
  "tenantId": "uuid",
  "distanceKm": 12.5,
  "durationMinutes": 25,
  "vehicleCategory": "SEDAN",
  "tripTime": "2026-01-03T18:30:00"
}

Response: 200 OK
{
  "id": "uuid",
  "tripId": "uuid",
  "baseFare": 4.00,
  "distanceFare": 12.50,
  "timeFare": 5.00,
  "subtotal": 21.50,
  "vehicleMultiplier": 1.0,
  "timeMultiplier": 1.5,
  "totalAmount": 32.30,
  "breakdown": {
    "baseFare": 4.00,
    "distance": "12.5 km √ó R$ 1.00/km = R$ 12.50",
    "time": "25 min √ó R$ 0.20/min = R$ 5.00",
    "vehicleCategory": "SEDAN √ó 1.0",
    "timeOfDay": "PEAK √ó 1.5",
    "total": "R$ 32.30"
  }
}
```

### POST /api/v1/payments
```json42 novos testes

- PaymentTest: 30 tests
- FareTest: 25 tests
- FareConfigurationTest: 20 tests
- PaymentMethodTest: 15 tests
- FareBreakdownTest: 10 tests
- ProcessPaymentUseCaseTest: 12 tests
- CalculateFareUseCaseTest: 12 tests
- RefundPaymentUseCaseTest: 8 tests
- UpdateFareConfigurationUseCaseTest: 10 tests

**Total projetado**: 446 testes (304 atuais + 142
Response: 201 Created
{
  FareConfiguration** implementada com persist√™ncia em banco:

**Valores Padr√£o** (criados automaticamente na migration para cada tenant):
- Base: R$ 4.00
- Por km: R$ 1.00
- Por minuto: R$ 0.20
- M√≠nima: R$ 8.00
- Comiss√£o: 20%

**Parametriza√ß√£o via Admin API**:
- Cada tenant pode ter tarifas customizadas
- Altera√ß√µes via `PUT /api/v1/admin/fare-configurations/{tenantId}`
- Valida√ß√µes garantem valores consistentes
- Hist√≥rico de altera√ß√µes via `updated_at`
- Futuramente: versionamento de configura√ß√µes para auditoria1/payments/{id}/refund
```json
Request:
{
  "reason": "Customer complaint - driver took wrong route"
}

Response: 200 OK
{
  "id": "uuid",
  "status": "REFUNDED",
  "refundedAt": "2026-01-04T10:00:00"
}
```

### GET /api/v1/payments/{id}
```
Response: 200 OK
```
FareConfiguration persistida no banco (tabela fare_configurations)
- ‚úÖ Repository e gateway ports implementados
- ‚úÖ Use cases com l√≥gica de c√°lculo e processamento
- ‚úÖ REST API RESTful com DTOs (incluindo Admin API)
- ‚úÖ Migration V5 criada com tabela de configura√ß√µes
- ‚úÖ Mock payment gateway funcionando
- ‚úÖ C√°lculo de tarifa usando configura√ß√£o do banco (n√£o hardcoded)
- ‚úÖ Comiss√£o calculada usando taxa do FareConfiguration
- ‚úÖ Admin API para CRUD de configura√ß√µes de tarifa
- ‚úÖ Valores padr√£o inseridos automaticamente na migration
- ‚úÖ Testes unit√°rios cobrindo todos os cen√°rios
- ‚úÖ Arquitetura hexagonal mantida
- ‚úÖ Todos os testes passando (446
**PaymentTest** (~30 tests):
- ‚úÖ shouldCreatePaymentWithValidData
- ‚úÖ shouldCalculatePlatformFeeAs20Percent
- ‚úÖ~~**Configura√ß√£o por Tenant**: Tarifas customiz√°veis via admin~~ ‚úÖ **IMPLEMENTADO**
3. **Versionamento de Tarifas**: Hist√≥rico de altera√ß√µes de configura√ß√£o
4. **Hist√≥rico Financeiro**: Dashboard de ganhos para motoristas
5. **Relat√≥rios**: Extratos, notas fiscais
6. **Webhooks**: Notifica√ß√µes ass√≠ncronas do gateway
7. **Antifraude**: Valida√ß√£o de transa√ß√µes suspeitas
8. **Split Payment**: Dividir pagamento automaticamente (motorista + plataforma)
9. **Promo√ß√µes/Descontos**: Cupons, primeira viagem gr√°tis, desconto por fidelidade
10. **Tarifas Din√¢micas**: Surge pricing em hor√°rios de alta demanda
- ‚úÖ shouldThrowExceptionWhenRefundingCashPayment
- ‚úÖ canBeRefundedShouldReturnTrueForCompletedCardPayment
- ‚úÖ canBeRefundedShouldReturnFalseForCashPayment
- ‚úÖ shouldNotAllowStatusRetrogression
- ‚úÖ amountMustBePositive
- ‚úÖ platformFeeAndDriverAmountMustSumToTotal

**FareTest** (~25 tests):
- ‚úÖ shouldCalculateFareWithBasePlusDistancePlusTime
- ‚úÖ shouldApplyPeakHourMultiplier
- ‚úÖ shouldApplyLateNightMultiplier
- ‚úÖ shouldApplySedanMultiplier
- ‚úÖ shouldApplySUVMultiplier
- ‚úÖ shouldApplyHatchbackMultiplier
- ‚úÖ shouldEnforceMinimumFare
- ‚úÖ shouldRoundUpToNearestTenCents
- ‚úÖ shouldCalculateBreakdownCorrectly, que busca FareConfiguration do reposit√≥rio.

**Raz√£o**: C√°lculo depende de configura√ß√µes persistidas no banco (tenant-specific), tornando use case mais apropriado que factory method no dom√≠nio.

**Alternativa**: FareCalculatorService no dom√≠nio - mas exigiria injetar FareConfigurationRepositoryPort no dom√≠nio, violando hexagonal architecture.

### ADR-004: Configura√ß√µes Parametriz√°veis desde MVP

**Decis√£o**: Implementar FareConfiguration com persist√™ncia no banco e Admin API desde o MVP, ao inv√©s de valores hardcoded.

**Raz√£o**: 
- White-label exige flexibilidade de tarifas por tenant desde o in√≠cio
- Evita refatora√ß√£o futura para migrar de hardcoded para database
- Facilita testes A/B de pricing
- Permite ajustes r√°pidos sem deploy

**Alternativa**: Valores fixos no c√≥digo + migra√ß√£o futura - mas geraria d√≠vida t√©cnica e n√£o atende requisitos de white-label.

**Trade-off**: Aumenta complexidade inicial (mais 1 entity, mais tests), mas reduz rigidez e facilita evolu
- ‚úÖ shouldCreateCreditCardMethod
- ‚úÖ shouldCreateDebitCardMethod
- ‚úÖ shouldCreatePixMethod
- ‚úÖ shouldCreateCashMethod
- ‚úÖ shouldValidateCardLast4Digits
- ‚úÖ shouldThrowExceptionForInvalidCardLast4
- ‚úÖ canBeRefundedShouldReturnTrueForCard
- ‚úÖ canBeRefundedShouldReturnFalseForCash

**FareBreakdownTest** (~10 tests):
- ‚úÖ shouldCalculateTotalCorrectly
- ‚úÖ shouldShowAllComponents
- ‚úÖ shouldFormatMoneyValues

### Use Case Tests

**ProcessPaymentUseCaseTest** (~12 tests):
- ‚úÖ shouldProcessCreditCardPaymentSuccessfully
- ‚úÖ shouldProcessPixPaymentSuccessfully
- ‚úÖ shouldProcessCashPaymentWithoutGateway
- ‚úÖ shouldFailPaymentWhenGatewayFails
- ‚úÖ shouldCalculateCorrectCommission
- ‚úÖ shouldUpdateTripStatusToCompleted

**CalculateFareUseCaseTest** (~10 tests):
- ‚úÖ shouldCalculateNormalFare
- ‚úÖ shouldCalculatePeakHourFare
- ‚úÖ shouldCalculateLateNightFare
- ‚úÖ shouldApplyMinimumFare
- ‚úÖ shouldCalculateForDifferentVehicleTypes

**RefundPaymentUseCaseTest** (~8 tests):
- ‚úÖ shouldRefundCompletedPayment
- ‚úÖ shouldThrowExceptionWhenRefundingCash
- ‚úÖ shouldThrowExceptionWhenPaymentNotFound

### Architecture Tests

Atualizar HexagonalArchitectureTest:
```java
.orShould().implement(PaymentRepositoryPort.class)
.orShould().implement(ProcessPaymentInputPort.class)
.orShould().implement(CalculateFareInputPort.class)
.orShould().implement(GetPaymentInputPort.class)
.orShould().implement(RefundPaymentInputPort.class)
```

## Estimativa de Testes

**Total esperado**: ~110 novos testes

- PaymentTest: 30 tests
- FareTest: 25 tests
- PaymentMethodTest: 15 tests
- FareBreakdownTest: 10 tests
- ProcessPaymentUseCaseTest: 12 tests
- CalculateFareUseCaseTest: 10 tests
- RefundPaymentUseCaseTest: 8 tests

**Total projetado**: 414 testes (304 atuais + 110 novos)

## Configura√ß√£o de Tarifas por Tenant

**TenantConfiguration** (adi√ß√£o futura):
```java
public class TenantFareConfiguration {
    private Money baseFare;              // R$ 4.00
    private Money pricePerKm;            // R$ 1.00/km
    private Money pricePerMinute;        // R$ 0.20/min
    private Money minimumFare;           // R$ 8.00
    private double platformCommission;   // 0.20 (20%)
}
```

Por ora, usar valores fixos no c√≥digo:
- Base: R$ 4.00
- Por km: R$ 1.00
- Por minuto: R$ 0.20
- M√≠nima: R$ 8.00
- Comiss√£o: 20%

## Integra√ß√µes Futuras

**Gateways de Pagamento**:
1. **Stripe**: Cart√µes internacionais
2. **Mercado Pago**: Brasil, Am√©rica Latina
3. **PagSeguro**: Brasil
4. **PIX**: Integra√ß√£o com BACEN (via Mercado Pago/PagSeguro)

**Implementa√ß√£o Atual**: Mock adapter para MVP

## Crit√©rios de Aceita√ß√£o

- ‚úÖ Domain entities sem framework annotations
- ‚úÖ Value objects imut√°veis com valida√ß√µes
- ‚úÖ Repository e gateway ports implementados
- ‚úÖ Use cases com l√≥gica de c√°lculo e processamento
- ‚úÖ REST API RESTful com DTOs
- ‚úÖ Migration V5 criada
- ‚úÖ Mock payment gateway funcionando
- ‚úÖ C√°lculo de tarifa com m√∫ltiplos multiplicadores
- ‚úÖ Comiss√£o 20% calculada corretamente
- ‚úÖ Testes unit√°rios cobrindo todos os cen√°rios
- ‚úÖ Arquitetura hexagonal mantida
- ‚úÖ Todos os testes passando (414 total)

## Pr√≥ximos Passos P√≥s-Implementa√ß√£o

1. **Integra√ß√£o Gateway Real**: Substituir mock por Stripe/Mercado Pago
2. **Configura√ß√£o por Tenant**: Tarifas customiz√°veis via admin
3. **Hist√≥rico Financeiro**: Dashboard de ganhos para motoristas
4. **Relat√≥rios**: Extratos, notas fiscais
5. **Webhooks**: Notifica√ß√µes ass√≠ncronas do gateway
6. **Antifraude**: Valida√ß√£o de transa√ß√µes suspeitas
7. **Split Payment**: Dividir pagamento automaticamente (motorista + plataforma)

## ADRs (Architecture Decision Records)

### ADR-001: Money em Centavos no Banco

**Decis√£o**: Armazenar valores monet√°rios em centavos (BIGINT) ao inv√©s de DECIMAL.

**Raz√£o**: Evitar erros de arredondamento com ponto flutuante. R$ 10.50 = 1050 centavos.

**Alternativas**: DECIMAL(10,2) - mais leg√≠vel mas pode ter erros de precis√£o.

### ADR-002: Mock Payment Gateway para MVP

**Decis√£o**: Usar adapter mock ao inv√©s de integra√ß√£o real com gateway.

**Raz√£o**: MVP n√£o precisa processar pagamentos reais, apenas simular fluxo. Reduz depend√™ncias externas e custos.

**Pr√≥ximo Passo**: Implementar StripePaymentGatewayAdapter quando MVP validado.

### ADR-003: C√°lculo de Tarifa no Use Case

**Decis√£o**: L√≥gica de c√°lculo de tarifa centralizada em CalculateFareUseCase ao inv√©s de dom√≠nio.

**Raz√£o**: C√°lculo depende de configura√ß√µes externas (tenant), tornando use case mais apropriado que entidade.

**Alternativa**: FareCalculatorService no dom√≠nio - mas exigiria injetar configura√ß√£o.

## Refer√™ncias

- [Stripe API Documentation](https://stripe.com/docs/api)
- [Mercado Pago API](https://www.mercadopago.com.br/developers/pt/docs)
- [PIX - Banco Central do Brasil](https://www.bcb.gov.br/estabilidadefinanceira/pix)
- Martin Fowler - Money Pattern
- Domain-Driven Design - Eric Evans (Money as Value Object)
