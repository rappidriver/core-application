# HIST-2026-009: Outbox Relay & Resiliência em Integrações Externas

## Contexto
O RappiDrive já implementa o Transactional Outbox Pattern para escrita, mas os eventos ficam presos na tabela `outbox_events`. É necessário processar e despachar esses eventos, além de tornar integrações externas resilientes a falhas.

## Objetivo
- Implementar o mecanismo de processamento (Relay) para o Outbox Pattern.
- Adicionar padrões de resiliência (Retry/Circuit Breaker) nas integrações externas.

## Critérios de Aceite

### 1. OutboxEventProcessor (Infrastructure)
- Componente Spring agendado (`@Scheduled`) que executa a cada X ms.
- Busca eventos PENDING na tabela `outbox_events`.
- Para cada evento:
  - Tenta despachar via `EventDispatcherPort` (simulação inicial com logger).
  - Se sucesso: atualiza status para PROCESSED e grava data de processamento.
  - Se falha: incrementa tentativas; se exceder max-retries, marca como FAILED.
- Usa bloqueio para evitar concorrência (`SELECT ... FOR UPDATE SKIP LOCKED` no Postgres).

### 2. Resilience4j nas integrações externas
- Adiciona dependência `spring-cloud-starter-circuitbreaker-resilience4j` ao `pom.xml`.
- Refatora/adiciona Adapter externo (ex: `MockPaymentGatewayAdapter` ou `RestPaymentGatewayAdapter`) para usar `@CircuitBreaker` e/ou `@Retry`.
- Implementa fallback lançando `PaymentServiceUnavailableException` em caso de falha.

### 3. Observabilidade
- Adiciona logs estruturados (MDC) no `OutboxEventProcessor` para rastrear o `correlationId` do evento.

## Entregáveis
- `OutboxEventProcessor.java` (agendador relay dos eventos)
- Atualização do `JpaOutboxRepositoryAdapter` (método para buscar pendentes com lock)
- Exemplo de configuração Resilience4j no `application.yml`
- Exemplo de Adapter externo usando `@CircuitBreaker` e fallback
- Logs estruturados com MDC/correlationId no processador

## Notas técnicas
- O processador deve ser idempotente e seguro para execução concorrente.
- O padrão de retry/circuit breaker deve ser aplicado apenas nas integrações externas, nunca no commit do outbox.
- O fallback deve lançar exceção de domínio apropriada para tratamento no use case.
