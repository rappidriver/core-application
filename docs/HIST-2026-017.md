# HIST-2026-017: Cancelamento de Corridas com Pol√≠tica de Tarifa

**Data**: 13/01/2026  
**Status**: üìã Planejado  
**Tipo**: Feature / Neg√≥cio  
**Tamanho**: M√©dio (2-3 dias)  
**Prioridade**: Alta

---

## 1. Contexto & Motiva√ß√£o

### Situa√ß√£o Atual
A aplica√ß√£o permite criar, atribuir, iniciar e completar corridas, mas **n√£o possui fluxo de cancelamento** estruturado:
- ‚ùå Passageiros e motoristas n√£o conseguem cancelar corridas ap√≥s cria√ß√£o
- ‚ùå Sem pol√≠tica de cobran√ßa por cancelamento (ex: 5min gratuito, ap√≥s isso cobra R$ 5,00)
- ‚ùå Sem registro do motivo do cancelamento para an√°lise posterior
- ‚ùå Trip cancelada n√£o libera motorista para aceitar nova corrida

### Por Que √â Importante?
**Cancelamento √© um fluxo cr√≠tico de neg√≥cio**:
- üìä **Taxa de cancelamento** √© KPI fundamental (meta: <5%)
- üí∞ **Pol√≠tica de tarifa** evita cancelamentos abusivos (no-show, mudan√ßa de ideia)
- üöó **Disponibilidade do motorista** impacta diretamente na oferta de corridas
- üìà **Motivos de cancelamento** geram insights para melhorias (UX ruim, pre√ßo alto, etc.)

### Alinhamento com Arquitetura
- **Domain Layer**: L√≥gica de neg√≥cio de cancelamento vive na entidade `Trip` e servi√ßo de dom√≠nio `CancellationPolicyService`
- **Application Layer**: Use cases orquestram regras, c√°lculo de tarifa e notifica√ß√µes
- **Infrastructure Layer**: Persist√™ncia, adapters de pagamento/notifica√ß√£o

---

## 2. Objetivo

Implementar **cancelamento de corridas com pol√≠tica de tarifa diferenciada** para passageiros e motoristas, registrando motivo e cobrando taxa quando aplic√°vel.

### Regras de Neg√≥cio

#### Pol√≠tica de Cancelamento - Passageiro
| Status da Trip | Tempo desde cria√ß√£o | Taxa de Cancelamento |
|---------------|---------------------|---------------------|
| REQUESTED     | < 5 minutos         | Gr√°tis              |
| REQUESTED     | ‚â• 5 minutos         | R$ 5,00             |
| ASSIGNED      | < 2 minutos         | Gr√°tis              |
| ASSIGNED      | ‚â• 2 minutos         | R$ 8,00             |
| IN_PROGRESS   | Qualquer            | N√£o permitido       |
| COMPLETED     | Qualquer            | N√£o permitido       |

#### Pol√≠tica de Cancelamento - Motorista
| Status da Trip | Condi√ß√£o | Penalidade |
|---------------|----------|-----------|
| ASSIGNED      | < 5 cancelamentos/dia | Sem penalidade |
| ASSIGNED      | ‚â• 5 cancelamentos/dia | Bloqueio tempor√°rio (1h) |
| IN_PROGRESS   | Qualquer | Penalidade grave (avalia√ß√£o manual) |

#### Motivos de Cancelamento
- **Passageiro**: `CHANGE_OF_PLANS`, `PRICE_TOO_HIGH`, `WAIT_TOO_LONG`, `WRONG_LOCATION`, `OTHER`
- **Motorista**: `PASSENGER_NOT_FOUND`, `UNSAFE_LOCATION`, `VEHICLE_ISSUE`, `OTHER`

---

## 3. Crit√©rios de Aceite

### 3.1 Domain Layer

**Value Objects**:
- ‚úÖ `CancellationReason` (enum com motivos + descri√ß√£o opcional)
- ‚úÖ `CancellationFee` (Money + motivo da cobran√ßa)

**Entity**:
- ‚úÖ `Trip.cancel(actor: ActorType, reason: CancellationReason, cancelledAt: LocalDateTime)`
  - Valida que status permite cancelamento
  - Registra quem cancelou (PASSENGER | DRIVER)
  - Armazena motivo e timestamp
  - Publica `TripCancelledEvent`

**Domain Service**:
- ‚úÖ `CancellationPolicyService.calculateFee(trip: Trip, actor: ActorType): CancellationFee`
  - Aplica regras de neg√≥cio por status e tempo decorrido
  - Retorna fee (pode ser zero) e justificativa

**Domain Event**:
- ‚úÖ `TripCancelledEvent(tripId, cancelledBy, reason, fee, timestamp)`

### 3.2 Application Layer

**Input Ports**:
- ‚úÖ `CancelTripInputPort` com comando contendo `tripId`, `actorType`, `reason`, `userId`

**Use Case**: `CancelTripUseCase`
- ‚úÖ Valida que usu√°rio autenticado √© passageiro ou motorista da trip
- ‚úÖ Calcula taxa usando `CancellationPolicyService`
- ‚úÖ Cancela trip no dom√≠nio
- ‚úÖ Se taxa > 0: processa cobran√ßa via `PaymentGatewayPort`
- ‚úÖ Notifica contraparte (se motorista cancelou, notifica passageiro e vice-versa)
- ‚úÖ Salva trip e publica evento via Outbox
- ‚úÖ Se motorista cancelou: incrementa contador di√°rio de cancelamentos
- ‚úÖ Retorna resultado com `cancelled`, `feeCharged`, `refundIssued`

### 3.3 Infrastructure Layer

**Repository**:
- ‚úÖ `DriverRepositoryPort.incrementCancellationsToday(driverId, tenantId)`
- ‚úÖ `DriverRepositoryPort.getCancellationsToday(driverId, tenantId): int`

**Adapter**:
- ‚úÖ Implementa√ß√£o JPA dos m√©todos acima (pode usar Redis para contador di√°rio se preferir)

### 3.4 Presentation Layer

**Endpoints**:
```http
POST /api/v1/trips/{tripId}/cancel
Authorization: Bearer {token}
Content-Type: application/json

{
  "reason": "WAIT_TOO_LONG",
  "additionalNotes": "Esperando h√° 15 minutos"
}

Response 200:
{
  "tripId": "uuid",
  "status": "CANCELLED",
  "cancelledBy": "PASSENGER",
  "cancelledAt": "2026-01-13T23:15:00Z",
  "cancellationFee": {
    "amount": 5.00,
    "currency": "BRL",
    "reason": "Cancelamento ap√≥s 5 minutos da solicita√ß√£o"
  },
  "refunded": false
}
```

**Seguran√ßa**:
- ‚úÖ Passageiro s√≥ pode cancelar trips dele
- ‚úÖ Motorista s√≥ pode cancelar trips atribu√≠das a ele
- ‚úÖ Endpoint usa `@PreAuthorize("hasAnyRole('PASSENGER', 'DRIVER')")`

### 3.5 Testes

**Testes Unit√°rios**:
- ‚úÖ `CancellationPolicyService` com cen√°rios de taxa (gr√°tis, R$ 5, R$ 8)
- ‚úÖ `Trip.cancel()` valida√ß√µes de estado
- ‚úÖ `CancelTripUseCase` com mocks

**Testes de Integra√ß√£o**:
- ‚úÖ Cancelamento via API com Testcontainers (PostgreSQL + Keycloak)
- ‚úÖ Verificar que evento foi persistido na tabela `outbox_event`
- ‚úÖ Verificar que contador de cancelamentos foi incrementado (motorista)

**Testes E2E**:
- ‚úÖ Fluxo completo: criar trip ‚Üí atribuir motorista ‚Üí passageiro cancela ap√≥s 6min ‚Üí verifica cobran√ßa R$ 5
- ‚úÖ Fluxo: motorista cancela 5x no mesmo dia ‚Üí 6¬™ tentativa retorna erro (limite di√°rio)

---

## 4. Entreg√°veis

### C√≥digo
1. `domain/valueobjects/CancellationReason.java` (enum)
2. `domain/valueobjects/CancellationFee.java`
3. `domain/valueobjects/ActorType.java` (enum: PASSENGER, DRIVER)
4. `domain/services/CancellationPolicyService.java`
5. `domain/events/TripCancelledEvent.java`
6. `domain/entities/Trip.java` (adicionar campos e m√©todo `cancel()`)
7. `application/ports/input/trip/CancelTripInputPort.java`
8. `application/usecases/trip/CancelTripUseCase.java`
9. `infrastructure/persistence/` (migra√ß√£o Flyway para novos campos em `trip`)
10. `presentation/controllers/TripController.java` (endpoint POST `/cancel`)
11. `presentation/dto/CancelTripRequest.java` e `CancelTripResponse.java`

### Testes
- 15+ testes unit√°rios cobrindo regras de neg√≥cio
- 5+ testes de integra√ß√£o
- 3+ testes E2E

### Documenta√ß√£o
- Atualizar README com regras de cancelamento e endpoints
- Adicionar exemplos de request/response

---

## 5. Notas T√©cnicas

### Transa√ß√£o e Idempot√™ncia
- Use case deve ser transacional (Spring `@Transactional`)
- Cancelar trip j√° cancelada retorna erro `TripAlreadyCancelledException`
- Evento publicado via Outbox garante entrega mesmo se notifica√ß√£o falhar

### Multi-Tenancy
- Todas as opera√ß√µes filtradas por `TenantId`
- Contador de cancelamentos isolado por tenant

### Performance
- Contador di√°rio de cancelamentos pode usar cache (Caffeine/Redis)
- Consulta de trip deve usar √≠ndice em `(tenant_id, trip_id, status)`

### Extensibilidade
- Pol√≠tica de tarifa pode ser externalizada para `FareConfiguration` (futura hist√≥ria)
- Motivos de cancelamento podem ser configur√°veis por tenant

---

## 6. Hist√≥rias Futuras (Fora do Escopo)

- **Reembolso autom√°tico**: se motorista cancela trip IN_PROGRESS, reembolsar passageiro
- **Dashboard de cancelamentos**: m√©tricas por motivo, hor√°rio, regi√£o
- **Bloqueio de usu√°rio**: ap√≥s N cancelamentos abusivos, bloquear conta temporariamente
- **Pol√≠tica customizada**: permitir tenant configurar taxas e limites pr√≥prios

---

## 7. Defini√ß√£o de Pronto (DoD)

- [ ] C√≥digo implementado seguindo arquitetura hexagonal
- [ ] Testes automatizados passando (cobertura > 80% nas classes de neg√≥cio)
- [ ] Migra√ß√£o Flyway aplicada
- [ ] Endpoint REST funcional e documentado
- [ ] Testes E2E passando com Keycloak + PostgreSQL
- [ ] Code review aprovado
- [ ] Documenta√ß√£o atualizada
- [ ] Nenhum coment√°rio excessivo (clean code)
