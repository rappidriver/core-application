> Este documento é histórico e pode conter implementações obsoletas. Consulte HIST-2026-012 para a referência atual.

# HIST-2025-005: Implementar REST Controllers (Presentation Layer)

**Data**: 03/01/2026  
**Status**: ✅ DONE  
**Tipo**: Feature

## Descrição

Implementar a camada de apresentação (REST API) para expor os casos de uso através de endpoints HTTP. Esta camada atua como adaptador driving (primário) na arquitetura hexagonal, convertendo requests HTTP em comandos para os use cases.

## Objetivos

1. Criar **REST Controllers** para Driver, Passenger e Trip
2. Implementar **DTOs** (Request/Response) para cada endpoint
3. Criar **Mappers** (DTO ↔ Domain)
4. Implementar **Global Exception Handler** (`@ControllerAdvice`)
5. Adicionar **validações** com Bean Validation
6. Implementar **testes de integração** com MockMvc
7. Documentar API com **Swagger/OpenAPI**

## Estrutura de Pacotes

```
src/main/java/com/rappidrive/presentation/
├── controllers/
│   ├── DriverController.java
│   ├── PassengerController.java
│   └── TripController.java
├── dto/
│   ├── request/
│   │   ├── CreateDriverRequest.java
│   │   ├── UpdateDriverLocationRequest.java
│   │   ├── CreatePassengerRequest.java
│   │   ├── CreateTripRequest.java
│   │   └── AssignDriverToTripRequest.java
│   └── response/
│       ├── DriverResponse.java
│       ├── PassengerResponse.java
│       ├── TripResponse.java
│       └── ErrorResponse.java
├── mappers/
│   ├── DriverDtoMapper.java
│   ├── PassengerDtoMapper.java
│   └── TripDtoMapper.java
└── exception/
    └── GlobalExceptionHandler.java
```

## Endpoints REST

### Driver Endpoints

```
POST   /api/v1/drivers                    # Criar motorista
GET    /api/v1/drivers/{id}               # Buscar motorista por ID
PUT    /api/v1/drivers/{id}/activate      # Ativar motorista
PUT    /api/v1/drivers/{id}/location      # Atualizar localização
GET    /api/v1/drivers?status={status}    # Listar motoristas por status
```

### Passenger Endpoints

```
POST   /api/v1/passengers                 # Criar passageiro
GET    /api/v1/passengers/{id}            # Buscar passageiro por ID
GET    /api/v1/passengers?status={status} # Listar passageiros por status
```

### Trip Endpoints

```
POST   /api/v1/trips                      # Criar viagem
GET    /api/v1/trips/{id}                 # Buscar viagem por ID
PUT    /api/v1/trips/{id}/assign-driver   # Atribuir motorista
PUT    /api/v1/trips/{id}/start           # Iniciar viagem
PUT    /api/v1/trips/{id}/complete        # Completar viagem
GET    /api/v1/trips?status={status}      # Listar viagens por status
```

## Request DTOs (Exemplos)

### CreateDriverRequest
```json
{
  "tenantId": "123e4567-e89b-12d3-a456-426614174000",
  "fullName": "João da Silva",
  "email": "joao.silva@example.com",
  "cpf": "12345678909",
  "phone": "+5511987654321",
  "driverLicense": {
    "number": "12345678901",
    "category": "B",
    "issueDate": "2020-01-01",
    "expiryDate": "2030-01-01"
  }
}
```

### CreateTripRequest
```json
{
  "tenantId": "123e4567-e89b-12d3-a456-426614174000",
  "passengerId": "123e4567-e89b-12d3-a456-426614174001",
  "origin": {
    "latitude": -23.550520,
    "longitude": -46.633308
  },
  "destination": {
    "latitude": -23.561684,
    "longitude": -46.656139
  }
}
```

## Response DTOs (Exemplos)

### DriverResponse
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "tenantId": "123e4567-e89b-12d3-a456-426614174001",
  "fullName": "João da Silva",
  "email": "joao.silva@example.com",
  "cpf": "123.456.789-09",
  "phone": "+55 11 98765-4321",
  "status": "ACTIVE",
  "currentLocation": {
    "latitude": -23.550520,
    "longitude": -46.633308
  },
  "createdAt": "2026-01-03T10:00:00",
  "updatedAt": "2026-01-03T10:30:00"
}
```

### ErrorResponse
```json
{
  "timestamp": "2026-01-03T10:00:00",
  "status": 404,
  "error": "Not Found",
  "message": "Driver not found with id: 123e4567-e89b-12d3-a456-426614174000",
  "path": "/api/v1/drivers/123e4567-e89b-12d3-a456-426614174000"
}
```

## Validações

### Bean Validation nas Requests
- `@NotNull` - campos obrigatórios
- `@NotBlank` - strings não vazias
- `@Email` - formato de email
- `@Pattern` - CPF, telefone, etc.
- `@Min/@Max` - valores numéricos
- `@Valid` - validação de objetos aninhados

### Exemplo
```java
public record CreateDriverRequest(
    @NotNull(message = "Tenant ID is required")
    UUID tenantId,
    
    @NotBlank(message = "Full name is required")
    @Size(min = 3, max = 100)
    String fullName,
    
    @NotBlank(message = "Email is required")
    @Email(message = "Invalid email format")
    String email,
    
    @NotBlank(message = "CPF is required")
    @Pattern(regexp = "\\d{11}", message = "CPF must be 11 digits")
    String cpf,
    
    @NotNull
    @Valid
    DriverLicenseRequest driverLicense
) {}
```

## Exception Handling

### GlobalExceptionHandler
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(DriverNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleDriverNotFound(DriverNotFoundException ex) {
        // 404 Not Found
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationErrors(MethodArgumentNotValidException ex) {
        // 400 Bad Request
    }
    
    @ExceptionHandler(InvalidDriverStateException.class)
    public ResponseEntity<ErrorResponse> handleInvalidState(InvalidDriverStateException ex) {
        // 409 Conflict
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGenericError(Exception ex) {
        // 500 Internal Server Error
    }
}
```

### Mapeamento de Exceções
- `NotFoundException` → 404 Not Found
- `InvalidStateException` → 409 Conflict
- `IllegalArgumentException` → 400 Bad Request
- `MethodArgumentNotValidException` → 400 Bad Request
- `Exception` → 500 Internal Server Error

## Testes de Integração

### DriverControllerIntegrationTest
```java
@WebMvcTest(DriverController.class)
class DriverControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private CreateDriverInputPort createDriverUseCase;
    
    @Test
    void shouldCreateDriver() throws Exception {
        // Given
        CreateDriverRequest request = ...;
        
        // When & Then
        mockMvc.perform(post("/api/v1/drivers")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.id").exists())
            .andExpect(jsonPath("$.fullName").value("João da Silva"));
    }
    
    @Test
    void shouldReturn400WhenInvalidRequest() throws Exception {
        // Invalid request (missing required fields)
        mockMvc.perform(post("/api/v1/drivers")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{}"))
            .andExpect(status().isBadRequest());
    }
}
```

## Swagger/OpenAPI

### Configuração
```java
@Configuration
@OpenAPIDefinition(
    info = @Info(
        title = "RappiDrive API",
        version = "1.0",
        description = "White-label ride-hailing platform API"
    )
)
public class OpenApiConfiguration {
    // Configuration beans
}
```

### Anotações nos Controllers
```java
@Tag(name = "Drivers", description = "Driver management endpoints")
@RestController
@RequestMapping("/api/v1/drivers")
public class DriverController {
    
    @Operation(summary = "Create a new driver")
    @ApiResponses(value = {
        @ApiResponse(responseCode = "201", description = "Driver created"),
        @ApiResponse(responseCode = "400", description = "Invalid request"),
        @ApiResponse(responseCode = "409", description = "Driver already exists")
    })
    @PostMapping
    public ResponseEntity<DriverResponse> createDriver(@Valid @RequestBody CreateDriverRequest request) {
        // ...
    }
}
```

## Critérios de Aceitação

- [ ] Todos os endpoints REST implementados
- [ ] DTOs com validações Bean Validation
- [ ] Mappers DTO ↔ Domain implementados
- [ ] GlobalExceptionHandler com todos os casos
- [ ] Testes de integração com MockMvc (> 80% cobertura)
- [ ] Swagger UI acessível em `/swagger-ui.html`
- [ ] Documentação OpenAPI em `/v3/api-docs`
- [ ] Headers CORS configurados
- [ ] Responses seguem padrão REST (status codes corretos)
- [ ] Logging adequado em todos os endpoints

## Dependências

- HIST-2025-004 (Ports e Interfaces) ✅

## Próximos Passos

- HIST-2025-006: Implementar autenticação e autorização JWT
- HIST-2025-007: Implementar WebSocket para rastreamento em tempo real
- HIST-2025-008: Implementar notificações push

## Notas Técnicas

- **Multi-tenancy**: Header `X-Tenant-ID` em todas as requisições
- **Versionamento**: API versionada via URI (`/api/v1/`)
- **Paginação**: Usar `Pageable` do Spring para listagens
- **Rate Limiting**: Considerar implementar em história futura
- **HATEOAS**: Opcional para MVP, considerar em versões futuras
