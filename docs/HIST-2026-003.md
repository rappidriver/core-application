# HIST-2026-003 ‚Äî Teste end-to-end (E2E) para cadastro de motorista üèçÔ∏è‚úÖ

## Status
**PLANNED** - Aguardando refatora√ß√£o de ambiente de teste para Testcontainers dedicado com PostgreSQL real.

## Contexto
Ap√≥s implementar o padr√£o Outbox e garantir persist√™ncia confi√°vel de eventos de dom√≠nio, precisamos validar que o fluxo completo de **cadastro de motorista** funciona corretamente:
- Motorista √© criado e persistido no banco de dados;
- Eventos de dom√≠nio (`DriverCreatedEvent`) s√£o capturados e inseridos na tabela `outbox_event`;
- O `OutboxPublisher` consome eventos pendentes e publica via `EventDispatcherPort`;
- M√©tricas e logs mostram o fluxo de forma observ√°vel.

## Objetivo
Implementar um teste E2E com Testcontainers que valida a rotina completa de **cria√ß√£o de motorista**, desde o recebimento da requisi√ß√£o HTTP at√© a publica√ß√£o e persist√™ncia do evento de dom√≠nio no Outbox, com retry e handling de falhas.

## Crit√©rios de Aceita√ß√£o ‚úÖ
1. Teste cria um motorista via HTTP POST `/api/drivers` com dados v√°lidos (nome, CPF, email, telefone, n√∫mero de carteira).
2. Motorista √© armazenado no banco de dados com status `AVAILABLE`.
3. Um evento `DriverCreatedEvent` √© publicado e inserido em `outbox_event` na mesma transa√ß√£o.
4. O `OutboxPublisher` consome e publica o evento com sucesso, marcando como `SENT`.
5. Se o `EventDispatcher` falhar, o evento √© retentado com backoff at√© m√°ximo de 5 tentativas.
6. Ap√≥s m√°ximo de tentativas excedido, o evento √© marcado como `FAILED` e entra em DLQ (dead-letter).
7. Teste valida todas as transi√ß√µes de estado: `PENDING` ‚Üí `SENT` (sucesso) ou `PENDING` ‚Üí `FAILED` (retry exhausted).
8. Logs e comportamento esperado s√£o verificados.

## Notas t√©cnicas
- A implementa√ß√£o do Outbox pattern (HIST-2026-002) j√° est√° **COMPLETA** e testada
- DomainEventsCollector est√° integrado em JpaTripRepositoryAdapter.save()
- Eventos s√£o drenados e persistidos na mesma transa√ß√£o que mudan√ßas do agregado
- OutboxPublisher j√° consome e publica eventos com retry/backoff
- E2E test requer ambiente separado com Testcontainers + PostgreSQL real (n√£o create-drop)

## Tarefas (seguir a numera√ß√£o)

### 1) Criar classe de teste E2E
- Path: `src/test/java/com/rappidrive/e2e/DriverRegistrationE2ETest.java`
- Anota√ß√µes: `@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)`
- Usar `@Testcontainers` e `@Container static PostgreSQLContainer` para banco de testes.
- Injetar `TestRestTemplate` ou `WebTestClient` para fazer requisi√ß√µes HTTP.

### 2) Implementar cen√°rio de sucesso
- **Dado**: uma requisi√ß√£o POST com dados v√°lidos de motorista;
- **Quando**: enviada a requisi√ß√£o para `POST /api/drivers`;
- **Ent√£o**: 
  - Resposta HTTP 201 (Created) com UUID de motorista;
  - Motorista existe no banco com status `AVAILABLE`;
  - Evento `DriverCreatedEvent` foi inserido em `outbox_event` com status `PENDING`;
  - Aguardar (com `Awaitility`) o publisher processar o evento;
  - Evento muda para status `SENT` em `outbox_event`.

### 3) Implementar cen√°rio de falha com retry
- **Dado**: um `EventDispatcherPort` mock que lan√ßa exce√ß√£o nas primeiras tentativas;
- **Quando**: o `OutboxPublisher` tenta publicar o evento 5 vezes;
- **Ent√£o**:
  - Primeiras 4 tentativas: evento permanece `PENDING` com campo `attempts` incrementando;
  - 5¬™ tentativa: evento √© marcado como `FAILED`;
  - Verificar logs: "Failed to dispatch event ...", "Event ... marked as FAILED after 5 attempts".

### 4) Valida√ß√£o de observabilidade
- Verificar logs cont√™m mensagens informativas (INFO para sucesso, WARN/ERROR para falhas).
- Verificar campos `created_at`, `sent_at`, `attempts`, `next_attempt_at` s√£o preenchidos corretamente.
- Testar busca de eventos `PENDING` e `FAILED` via reposit√≥rio.

### 5) Testes adicionais (opcional)
- Teste de duplica√ß√£o: mesmo evento enviado twice ‚Üí idempot√™ncia (mesma tentativa n√£o duplica);
- Teste de timeout na rede: simular falha de conex√£o e verificar retry;
- Teste de concorr√™ncia: m√∫ltiplos motoristas criados em paralelo ‚Üí m√∫ltiplos eventos no outbox.

## Dados de entrada de exemplo
```json
POST /api/drivers
{
  "tenantId": "123e4567-e89b-12d3-a456-426614174000",
  "name": "Jo√£o Silva",
  "cpf": "12345678901",
  "email": "joao@example.com",
  "phone": "+5511987654321",
  "licenseNumber": "1234567890"
}
```

## Resultado esperado
- HTTP 201 com payload de motorista criado.
- Banco de dados cont√©m o motorista com `status = 'AVAILABLE'`.
- Tabela `outbox_event` cont√©m uma linha com `event_type = 'DriverCreatedEvent'` e `status = 'SENT'` (ap√≥s publica√ß√£o bem-sucedida).
- Logs mostram sequ√™ncia clara: "Event ... dispatched".

## Depend√™ncias adicionais (pom.xml)
- `org.testcontainers:testcontainers` (j√° existe)
- `org.testcontainers:postgresql` (j√° existe)
- `org.awaitility:awaitility` (adicionar se n√£o existir) ‚Äî permite esperar por condi√ß√µes ass√≠ncronas.

## Refer√™ncias
- [Testcontainers Docs](https://testcontainers.com/)
- [Awaitility GitHub](https://github.com/awaitility/awaitility)
- HIST-2026-002 (Outbox pattern implementation)
